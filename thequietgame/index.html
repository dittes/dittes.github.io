<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>The Quiet Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
/* ============================================
   THE QUIET GAME â€” Styles
   ============================================ */
:root {
  --bg: #08090d;
  --bg2: #0e1016;
  --surface: #161820;
  --surface2: #1e2029;
  --border: #282a36;
  --border-hi: #3a3d4d;
  --text: #e4e2dc;
  --text2: #9b98a0;
  --text3: #5c5960;
  --text4: #3a3840;
  --gold: #c9a84c;
  --gold-dim: rgba(201,168,76,0.12);
  --gold-glow: rgba(201,168,76,0.25);
  --green: #3ee88a;
  --green-bg: #071e12;
  --green-dim: rgba(62,232,138,0.10);
  --red: #f0544a;
  --red-bg: #1e0a0b;
  --red-dim: rgba(240,84,74,0.10);
  --amber: #e8a840;
  --font-serif: 'Cormorant Garamond','Georgia',serif;
  --font-mono: 'JetBrains Mono','SF Mono','Fira Code','Consolas',monospace;
  --r: 14px;
  --r-sm: 8px;
  --r-full: 999px;
  --speed: 0.22s;
}

*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px;-webkit-text-size-adjust:100%}

body{
  font-family:var(--font-mono);font-weight:400;font-size:0.82rem;
  background:var(--bg);color:var(--text);
  min-height:100dvh;overflow:hidden;-webkit-font-smoothing:antialiased;
}

button{
  font-family:inherit;font-size:inherit;border:none;cursor:pointer;
  outline:none;background:none;color:inherit;
  -webkit-tap-highlight-color:transparent;
}
button:focus-visible{outline:2px solid var(--gold);outline-offset:2px}
fieldset{border:none}
a{color:var(--gold);text-decoration:none}
a:hover{text-decoration:underline}
strong{font-weight:500;color:var(--text)}

.mono{
  font-family:var(--font-mono);
  font-variant-numeric:tabular-nums;
  font-feature-settings:'tnum' 1;
}

/* App */
#app{position:relative;width:100%;min-height:100dvh}

.screen{
  display:none;flex-direction:column;
  min-height:100dvh;padding:20px;
  padding-top:max(20px,env(safe-area-inset-top));
  padding-bottom:max(20px,env(safe-area-inset-bottom));
}
.screen.active{display:flex;animation:screenIn .45s ease}
@keyframes screenIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ---- Progress Border ---- */
.progress-border{
  position:fixed;inset:0;width:100%;height:100%;z-index:50;
  pointer-events:none;opacity:0;transition:opacity .5s ease;
}
.progress-border.visible{opacity:1}
#progress-rect{
  fill:none;stroke:var(--gold);stroke-width:4;
  filter:drop-shadow(0 0 8px var(--gold-glow));
  transition:stroke .3s ease;
}
.progress-border.danger #progress-rect{
  stroke:var(--red);
  filter:drop-shadow(0 0 10px var(--red-dim));
}

/* ---- IDLE ---- */
#screen-idle{justify-content:space-between;gap:20px}
.idle-header{text-align:center;padding-top:clamp(24px,6vh,56px)}
.title-row{display:flex;justify-content:center;align-items:flex-start;gap:12px;position:relative}

.game-title{
  font-family:var(--font-serif);
  font-size:clamp(3rem,11vw,5.5rem);
  font-weight:300;line-height:.95;letter-spacing:-.03em;
}
.game-title em{font-weight:300;font-style:italic;color:var(--gold)}

.btn-icon{
  width:36px;height:36px;display:flex;align-items:center;justify-content:center;
  border-radius:50%;color:var(--text3);transition:color var(--speed),background var(--speed);
  flex-shrink:0;margin-top:8px;
}
.btn-icon:hover{color:var(--text);background:var(--surface)}

.game-subtitle{
  margin-top:10px;font-size:.7rem;font-weight:400;
  color:var(--text3);letter-spacing:.2em;text-transform:uppercase;
}

.idle-body{display:flex;flex-direction:column;gap:32px;max-width:420px;width:100%;margin:0 auto}
.field-group{display:flex;flex-direction:column}
.section-label{
  font-size:.65rem;font-weight:500;color:var(--text3);
  letter-spacing:.14em;text-transform:uppercase;margin-bottom:12px;
}

.duration-options{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.duration-btn{
  padding:14px 4px;border-radius:var(--r-sm);background:var(--surface);
  border:1px solid var(--border);font-size:.82rem;color:var(--text2);transition:all var(--speed);
}
.duration-btn:hover{background:var(--surface2);color:var(--text)}
.duration-btn.selected{background:var(--gold-dim);border-color:var(--gold);color:var(--gold)}

.threshold-row{display:flex;align-items:center;gap:14px}
.threshold-value{
  font-family:var(--font-mono);font-size:.82rem;color:var(--gold);
  min-width:50px;text-align:right;
}

input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:28px;background:transparent}
input[type="range"]:focus-visible{outline:2px solid var(--gold);outline-offset:4px}
input[type="range"]::-webkit-slider-runnable-track{
  height:3px;background:linear-gradient(to right,var(--border),var(--border-hi));border-radius:2px;
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;width:20px;height:20px;border-radius:50%;
  background:var(--gold);border:3px solid var(--bg);
  box-shadow:0 0 0 1px var(--border-hi),0 0 12px var(--gold-dim);
  margin-top:-8.5px;cursor:pointer;
}
input[type="range"]::-moz-range-track{height:3px;background:var(--border);border-radius:2px;border:none}
input[type="range"]::-moz-range-thumb{
  width:20px;height:20px;border-radius:50%;background:var(--gold);
  border:3px solid var(--bg);box-shadow:0 0 0 1px var(--border-hi);cursor:pointer;
}

.threshold-actions{display:flex;justify-content:space-between;margin-top:12px}
.btn-text{
  font-size:.72rem;color:var(--text3);transition:color var(--speed);
  display:flex;align-items:center;gap:6px;
}
.btn-text:hover{color:var(--text2)}

.calibrate-dot{
  display:inline-block;width:7px;height:7px;border-radius:50%;
  background:var(--text3);transition:background var(--speed);
}
.calibrating .calibrate-dot{background:var(--amber);animation:pulseDot .5s ease infinite alternate}
@keyframes pulseDot{from{opacity:1;transform:scale(1)}to{opacity:.3;transform:scale(.7)}}
.calibrate-status{font-size:.72rem;color:var(--amber);min-height:1.3em;margin-top:6px}

.btn-start{
  width:100%;padding:20px;border-radius:var(--r);
  background:var(--text);color:var(--bg);
  display:flex;flex-direction:column;align-items:center;gap:3px;
  transition:transform var(--speed),box-shadow var(--speed);
}
.btn-start:hover{box-shadow:0 4px 30px rgba(228,226,220,.12)}
.btn-start:active{transform:scale(.97)}
.btn-start-label{font-family:var(--font-serif);font-size:1.5rem;font-weight:400;letter-spacing:.02em}
.btn-start-sub{font-size:.62rem;opacity:.45;letter-spacing:.06em}

.idle-footer{text-align:center}
.privacy-note{font-size:.6rem;color:var(--text4);line-height:1.5;letter-spacing:.02em}

/* ---- RUNNING ---- */
#screen-running{justify-content:space-between;align-items:center;gap:16px;position:relative}
#screen-running::before{
  content:'';position:absolute;top:30%;left:50%;width:120%;height:60%;
  transform:translate(-50%,-50%);
  background:radial-gradient(ellipse,rgba(201,168,76,.03),transparent 65%);
  pointer-events:none;
}

.running-top{text-align:center;padding-top:10px;z-index:1}
.timer-display{
  font-family:var(--font-mono);font-weight:300;
  font-size:clamp(3.2rem,15vw,7rem);
  line-height:1;letter-spacing:-.02em;color:var(--text);
  font-variant-numeric:tabular-nums;
  font-feature-settings:'tnum' 1;
}

.running-hint{font-size:.7rem;color:var(--text3);letter-spacing:.18em;text-transform:uppercase;margin-top:6px}
.paused-state .running-hint::after{content:' â€” paused';color:var(--amber)}
.paused-state .timer-display{animation:blinkTimer 1.4s steps(1) infinite}
@keyframes blinkTimer{0%,100%{opacity:1}50%{opacity:.25}}

.running-middle{display:flex;flex-direction:column;align-items:center;gap:24px;z-index:1}
.viz-wrap{position:relative;width:clamp(200px,52vw,320px);height:clamp(200px,52vw,320px)}
#viz-canvas{width:100%;height:100%;display:block}
.viz-center{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  text-align:center;display:flex;flex-direction:column;gap:1px;pointer-events:none;
}
.viz-level{font-size:clamp(1.1rem,3.5vw,1.6rem);font-weight:500;color:var(--text)}
.viz-unit{font-size:.55rem;color:var(--text3);text-transform:uppercase;letter-spacing:.2em}

.running-stats{display:flex;align-items:center;gap:28px}
.stat{display:flex;flex-direction:column;align-items:center;gap:2px}
.stat-val{font-size:.88rem;color:var(--text)}
.stat-lbl{font-size:.58rem;color:var(--text3);text-transform:uppercase;letter-spacing:.14em}
.stat-div{width:1px;height:24px;background:var(--border)}

.running-bottom{display:flex;gap:12px;width:100%;max-width:400px;z-index:1}
.btn-ctrl{
  flex:1;padding:15px 20px;border-radius:var(--r);font-size:.85rem;font-weight:500;
  transition:all var(--speed);
}
.btn-pause{background:var(--surface);border:1px solid var(--border)}
.btn-pause:hover{background:var(--surface2)}
.btn-stop{background:var(--red-dim);border:1px solid rgba(240,84,74,.2);color:var(--red)}
.btn-stop:hover{background:rgba(240,84,74,.14)}

/* ---- RESULTS ---- */
#screen-win,#screen-lose{justify-content:center;align-items:center;transition:background .6s ease}
#screen-win{background:var(--green-bg)}
#screen-lose{background:var(--red-bg)}

.result-wrap{text-align:center;max-width:380px;width:100%;animation:resultPop .5s cubic-bezier(.22,1,.36,1)}
@keyframes resultPop{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}

.result-badge{font-size:3.2rem;line-height:1;margin-bottom:20px}
.result-badge-win{color:var(--green);text-shadow:0 0 50px var(--green-dim)}
.result-badge-lose{color:var(--red);text-shadow:0 0 50px var(--red-dim)}

.result-title{
  font-family:var(--font-serif);font-size:clamp(2.6rem,10vw,4.2rem);
  font-weight:300;line-height:1.1;
}
.result-title-win{color:var(--green)}
.result-title-lose{color:var(--red)}
.result-msg{font-size:.82rem;color:var(--text2);margin-top:6px}

.result-stats{
  display:flex;justify-content:center;gap:32px;margin-top:48px;padding:20px;
  background:rgba(0,0,0,.35);border-radius:var(--r);border:1px solid rgba(255,255,255,.04);
}
.result-stat{display:flex;flex-direction:column;gap:4px}
.rs-label{font-size:.58rem;color:var(--text3);text-transform:uppercase;letter-spacing:.12em}
.rs-value{font-size:.95rem;color:var(--text)}

.btn-again{
  margin-top:36px;padding:14px 48px;border-radius:var(--r-full);
  font-family:var(--font-serif);font-size:1.2rem;font-weight:400;transition:all var(--speed);
}
.btn-again-win{background:var(--green);color:#052e16}
.btn-again-win:hover{box-shadow:0 0 36px var(--green-dim)}
.btn-again-lose{background:var(--red);color:#fff}
.btn-again-lose:hover{box-shadow:0 0 36px var(--red-dim)}

/* ---- OVERLAYS ---- */
.overlay{
  position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;
  background:rgba(8,9,13,.92);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:20px;animation:fadeOvIn .25s ease;
}
.overlay[hidden]{display:none}
@keyframes fadeOvIn{from{opacity:0}to{opacity:1}}

.overlay-box{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:36px 28px;max-width:400px;width:100%;text-align:center;position:relative;
}
.overlay-box-info{
  max-width:460px;text-align:left;max-height:85dvh;
  overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.overlay-icon{font-size:2.4rem;margin-bottom:14px}
.overlay-box h3{font-family:var(--font-serif);font-size:1.4rem;font-weight:400;margin-bottom:14px}
.overlay-box p{font-size:.78rem;color:var(--text2);line-height:1.65}

.mic-steps{text-align:left;padding-left:20px;margin:16px 0 24px}
.mic-steps li{font-size:.76rem;color:var(--text2);line-height:1.8}

.btn-overlay-close{
  padding:10px 32px;border-radius:var(--r-full);background:var(--surface2);
  border:1px solid var(--border);font-size:.82rem;color:var(--text);transition:background var(--speed);
}
.btn-overlay-close:hover{background:var(--border)}

.btn-modal-close{
  position:absolute;top:14px;right:14px;width:32px;height:32px;
  display:flex;align-items:center;justify-content:center;border-radius:50%;
  color:var(--text3);transition:color var(--speed),background var(--speed);
}
.btn-modal-close:hover{color:var(--text);background:var(--surface2)}

.info-title{font-family:var(--font-serif);font-size:1.6rem;font-weight:300;margin-bottom:24px;color:var(--text)}
.info-section{margin-bottom:20px}
.info-section h4{font-family:var(--font-serif);font-size:1rem;font-weight:400;color:var(--gold);margin-bottom:6px}
.info-section p{font-size:.76rem;color:var(--text2);line-height:1.7;margin-bottom:4px}
.info-divider{border:none;border-top:1px solid var(--border);margin:24px 0}

/* ---- RESPONSIVE ---- */
@media(min-width:768px){.screen{padding:32px}.result-stats{gap:48px}}
@media(max-height:640px){
  .idle-header{padding-top:12px}.game-title{font-size:2.4rem}
  .idle-body{gap:20px}.btn-start{padding:14px}
  .running-top{padding-top:4px}.viz-wrap{width:160px;height:160px}.running-middle{gap:14px}
}
@media(max-height:500px) and (orientation:landscape){
  #screen-running{flex-direction:row;flex-wrap:wrap;justify-content:center;align-items:center;gap:10px;padding:10px 20px}
  .running-top{padding-top:0}.timer-display{font-size:2.6rem}
  .viz-wrap{width:130px;height:130px}.running-bottom{max-width:280px}
}
  </style>
</head>
<body>
  <div id="app">

    <!-- Progress border -->
    <svg id="progress-border" class="progress-border" aria-hidden="true">
      <rect id="progress-rect" x="3" y="3" rx="0" ry="0" width="100" height="100" />
    </svg>

    <!-- ===== IDLE ===== -->
    <section id="screen-idle" class="screen active" aria-label="Game setup">
      <header class="idle-header">
        <div class="title-row">
          <h1 class="game-title">The Quiet<br><em>Game</em></h1>
          <button class="btn-icon btn-info" id="btn-info" aria-label="How it works and about">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          </button>
        </div>
        <p class="game-subtitle">Stay silent. Stay still. Win.</p>
      </header>

      <div class="idle-body">
        <fieldset class="field-group" role="radiogroup" aria-label="Select duration">
          <legend class="section-label">Duration</legend>
          <div class="duration-options">
            <button class="duration-btn" data-seconds="300" aria-pressed="false">5 min</button>
            <button class="duration-btn selected" data-seconds="900" aria-pressed="true">15 min</button>
            <button class="duration-btn" data-seconds="1800" aria-pressed="false">30 min</button>
            <button class="duration-btn" data-seconds="3600" aria-pressed="false">1 hr</button>
          </div>
        </fieldset>

        <div class="field-group">
          <label class="section-label" for="threshold-slider">Sensitivity</label>
          <div class="threshold-row">
            <input type="range" id="threshold-slider" min="0.005" max="0.15" step="0.001" value="0.035" aria-label="Sound threshold">
            <span class="threshold-value mono" id="threshold-display">0.035</span>
          </div>
          <div class="threshold-actions">
            <button class="btn-text" id="btn-calibrate" aria-label="Calibrate room noise for 2 seconds">
              <span class="calibrate-dot" id="calibrate-dot"></span>Calibrate (2 s)
            </button>
            <button class="btn-text" id="btn-reset-threshold">Reset</button>
          </div>
          <p id="calibrate-status" class="calibrate-status" aria-live="polite"></p>
        </div>

        <button class="btn-start" id="btn-start" aria-label="Start the quiet game">
          <span class="btn-start-label">Start</span>
          <span class="btn-start-sub">microphone required</span>
        </button>
      </div>

      <footer class="idle-footer">
        <p class="privacy-note">All audio is processed locally. Nothing is stored or uploaded.</p>
      </footer>
    </section>

    <!-- ===== RUNNING ===== -->
    <section id="screen-running" class="screen" aria-label="Game in progress">
      <div class="running-top">
        <div class="timer-display mono" aria-label="Time remaining">
          <span id="timer-text">15:00</span>
        </div>
        <p class="running-hint" id="running-hint">Remain quietâ€¦</p>
      </div>

      <div class="running-middle">
        <div class="viz-wrap" aria-label="Audio visualization">
          <canvas id="viz-canvas"></canvas>
          <div class="viz-center">
            <span class="viz-level mono" id="viz-level">0.000</span>
            <span class="viz-unit">RMS</span>
          </div>
        </div>
        <div class="running-stats">
          <div class="stat">
            <span class="stat-val mono" id="stat-peak">0.000</span>
            <span class="stat-lbl">peak</span>
          </div>
          <div class="stat-div"></div>
          <div class="stat">
            <span class="stat-val mono" id="stat-threshold">0.035</span>
            <span class="stat-lbl">threshold</span>
          </div>
        </div>
      </div>

      <div class="running-bottom">
        <button class="btn-ctrl btn-pause" id="btn-pause" aria-label="Pause">Pause</button>
        <button class="btn-ctrl btn-stop" id="btn-stop" aria-label="Stop">Stop</button>
      </div>
    </section>

    <!-- ===== WIN ===== -->
    <section id="screen-win" class="screen" aria-label="You won">
      <div class="result-wrap">
        <div class="result-badge result-badge-win">âœ¦</div>
        <h2 class="result-title result-title-win">You won!</h2>
        <p class="result-msg">It stayed quiet the entire time.</p>
        <div class="result-stats">
          <div class="result-stat"><span class="rs-label">Duration</span><span class="rs-value mono" id="win-duration">â€”</span></div>
          <div class="result-stat"><span class="rs-label">Max level</span><span class="rs-value mono" id="win-max-level">â€”</span></div>
          <div class="result-stat"><span class="rs-label">Threshold</span><span class="rs-value mono" id="win-threshold">â€”</span></div>
        </div>
        <button class="btn-again btn-again-win" id="btn-again-win">Play again</button>
      </div>
    </section>

    <!-- ===== LOSE ===== -->
    <section id="screen-lose" class="screen" aria-label="You lost">
      <div class="result-wrap">
        <div class="result-badge result-badge-lose">âœ•</div>
        <h2 class="result-title result-title-lose">You lost!</h2>
        <p class="result-msg">Sound detected above threshold.</p>
        <div class="result-stats">
          <div class="result-stat"><span class="rs-label">Time left</span><span class="rs-value mono" id="lose-time-left">â€”</span></div>
          <div class="result-stat"><span class="rs-label">Peak level</span><span class="rs-value mono" id="lose-peak">â€”</span></div>
          <div class="result-stat"><span class="rs-label">Threshold</span><span class="rs-value mono" id="lose-threshold">â€”</span></div>
        </div>
        <button class="btn-again btn-again-lose" id="btn-again-lose">Try again</button>
      </div>
    </section>

    <!-- ===== MIC ERROR ===== -->
    <div id="mic-error" class="overlay" role="alert" aria-live="assertive" hidden>
      <div class="overlay-box">
        <div class="overlay-icon">ðŸŽ¤</div>
        <h3>Microphone Required</h3>
        <p id="mic-error-msg">This game needs microphone access to detect sound.</p>
        <ol class="mic-steps">
          <li>Check the address bar for a blocked mic icon</li>
          <li>Tap it and select "Allow"</li>
          <li>Refresh the page and try again</li>
        </ol>
        <button class="btn-overlay-close" id="btn-dismiss-error">Got it</button>
      </div>
    </div>

    <!-- ===== INFO MODAL ===== -->
    <div id="info-modal" class="overlay" hidden>
      <div class="overlay-box overlay-box-info">
        <button class="btn-modal-close" id="btn-close-info" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <h3 class="info-title">How It Works</h3>
        <div class="info-section">
          <h4>The Game</h4>
          <p>Choose a duration and press Start. Your microphone listens for sound â€” if the room stays quiet below the threshold for the entire time, you win. If sound is detected above the threshold for more than ~200 ms, you lose immediately.</p>
        </div>
        <div class="info-section">
          <h4>Threshold &amp; Calibration</h4>
          <p>The sensitivity slider sets how loud a sound must be to trigger a loss. Use <strong>Calibrate</strong> to sample your room's baseline noise for 2 seconds â€” the threshold is then set to 30% above the ambient level. You can also adjust manually.</p>
        </div>
        <div class="info-section">
          <h4>The Visualization</h4>
          <p>The circular display shows a real-time frequency spectrum of what your microphone hears. The dashed ring marks your threshold. The colored glow shows current loudness. All processing happens locally â€” no audio is recorded, stored, or transmitted.</p>
        </div>
        <div class="info-section">
          <h4>Tips</h4>
          <p>Works best in a quiet environment. Close doors and windows. Put your phone face-down to avoid notification sounds. For long sessions, keep your device plugged in â€” the game requests a screen wake lock to prevent sleep.</p>
        </div>
        <hr class="info-divider">
        <div class="info-section">
          <h4>Imprint</h4>
          <p>Andreas Dittes<br>Bautzener Str. 35<br>10829 Berlin</p>
          <p><a href="mailto:quietgame@dittes.info">quietgame@dittes.info</a></p>
        </div>
        <button class="btn-overlay-close" id="btn-close-info-bottom">Close</button>
      </div>
    </div>
  </div>

<script>
/* ============================================
   THE QUIET GAME â€” App
   ============================================ */
(function() {
  'use strict';

  var DEFAULT_THRESHOLD = 0.035;
  var DEBOUNCE_MS       = 200;
  var CAL_DURATION      = 2000;
  var CAL_MARGIN        = 1.30;
  var FFT_SIZE          = 256;

  var gameState          = 'idle';
  var selectedDuration   = 900;
  var threshold          = DEFAULT_THRESHOLD;
  var durationMs         = 0;
  var startedAt          = 0;
  var elapsedBeforePause = 0;
  var remainingMs        = 0;
  var peakLevel          = 0;
  var currentLevel       = 0;
  var aboveThresholdAt   = null;

  var audioCtx   = null;
  var analyser   = null;
  var micStream  = null;
  var sourceNode = null;
  var rafId      = null;
  var canvas, ctx;
  var wakeLock   = null;
  var smoothFreq = null;

  /* ---- DOM ---- */
  function $(s) { return document.querySelector(s); }

  var screens = {
    idle:    $('#screen-idle'),
    running: $('#screen-running'),
    win:     $('#screen-win'),
    lose:    $('#screen-lose')
  };

  var el = {
    timerText:      $('#timer-text'),
    vizLevel:       $('#viz-level'),
    statPeak:       $('#stat-peak'),
    statThreshold:  $('#stat-threshold'),
    slider:         $('#threshold-slider'),
    sliderDisp:     $('#threshold-display'),
    calStatus:      $('#calibrate-status'),
    micError:       $('#mic-error'),
    micErrorMsg:    $('#mic-error-msg'),
    infoModal:      $('#info-modal'),
    btnStart:       $('#btn-start'),
    btnCalibrate:   $('#btn-calibrate'),
    btnResetTh:     $('#btn-reset-threshold'),
    btnPause:       $('#btn-pause'),
    btnStop:        $('#btn-stop'),
    btnAgainWin:    $('#btn-again-win'),
    btnAgainLose:   $('#btn-again-lose'),
    btnDismissErr:  $('#btn-dismiss-error'),
    btnInfo:        $('#btn-info'),
    btnCloseInfo:   $('#btn-close-info'),
    btnCloseInfo2:  $('#btn-close-info-bottom'),
    vizCanvas:      $('#viz-canvas'),
    progressBorder: $('#progress-border'),
    progressRect:   $('#progress-rect'),
    winDuration:    $('#win-duration'),
    winMaxLevel:    $('#win-max-level'),
    winThreshold:   $('#win-threshold'),
    loseTimeLeft:   $('#lose-time-left'),
    losePeak:       $('#lose-peak'),
    loseThreshold:  $('#lose-threshold')
  };

  /* ---- helpers ---- */
  function fmtTime(ms) {
    var totalSec = Math.max(0, Math.ceil(ms / 1000));
    var h  = Math.floor(totalSec / 3600);
    var m  = Math.floor((totalSec % 3600) / 60);
    var s  = totalSec % 60;
    var mm = String(m).padStart(2, '0');
    var ss = String(s).padStart(2, '0');
    return h > 0 ? h + ':' + mm + ':' + ss : mm + ':' + ss;
  }
  function fmtTimeSec(sec) { return fmtTime(sec * 1000); }
  function fmtLvl(v) { return v.toFixed(3); }

  function showScreen(name) {
    var keys = Object.keys(screens);
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      if (k === name) screens[k].classList.add('active');
      else screens[k].classList.remove('active');
    }
    var focusTarget = screens[name].querySelector('button, [tabindex]');
    if (focusTarget) setTimeout(function() { focusTarget.focus(); }, 120);
  }

  /* ---- progress border ---- */
  function sizeProgressRect() {
    var w = window.innerWidth;
    var h = window.innerHeight;
    var r = el.progressRect;
    r.setAttribute('width',  w - 6);
    r.setAttribute('height', h - 6);
    var perim = 2 * (w - 6) + 2 * (h - 6);
    r.style.strokeDasharray  = String(perim);
    r.style.strokeDashoffset = '0';
    r.dataset.perim = String(perim);
  }

  function updateProgressBorder(fraction) {
    var perim = parseFloat(el.progressRect.dataset.perim) || 0;
    el.progressRect.style.strokeDashoffset = String(perim * fraction);
  }

  /* ---- wake lock ---- */
  function acquireWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        navigator.wakeLock.request('screen').then(function(wl) { wakeLock = wl; }).catch(function(){});
      }
    } catch(e) {}
  }
  function releaseWakeLock() {
    if (wakeLock) { wakeLock.release().catch(function(){}); wakeLock = null; }
  }
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible' && gameState === 'running') acquireWakeLock();
  });

  /* ---- duration selection ---- */
  var durationBtns = document.querySelectorAll('.duration-btn');
  for (var i = 0; i < durationBtns.length; i++) {
    (function(btn) {
      btn.addEventListener('click', function() {
        for (var j = 0; j < durationBtns.length; j++) {
          durationBtns[j].classList.remove('selected');
          durationBtns[j].setAttribute('aria-pressed', 'false');
        }
        btn.classList.add('selected');
        btn.setAttribute('aria-pressed', 'true');
        selectedDuration = parseInt(btn.dataset.seconds, 10);
      });
    })(durationBtns[i]);
  }

  /* ---- threshold slider ---- */
  el.slider.addEventListener('input', function() {
    threshold = parseFloat(el.slider.value);
    el.sliderDisp.textContent = fmtLvl(threshold);
  });
  el.btnResetTh.addEventListener('click', function() {
    threshold = DEFAULT_THRESHOLD;
    el.slider.value = String(threshold);
    el.sliderDisp.textContent = fmtLvl(threshold);
  });

  /* ---- calibration ---- */
  el.btnCalibrate.addEventListener('click', function() {
    el.btnCalibrate.classList.add('calibrating');
    el.calStatus.textContent = 'Listening\u2026';

    navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: false }
    }).then(function(stream) {
      var c = new (window.AudioContext || window.webkitAudioContext)();
      var resumeP = (c.state === 'suspended') ? c.resume() : Promise.resolve();

      resumeP.then(function() {
        var src = c.createMediaStreamSource(stream);
        var an  = c.createAnalyser();
        an.fftSize = FFT_SIZE;
        src.connect(an);
        var buf = new Float32Array(an.fftSize);
        var maxRms = 0, sumRms = 0, n = 0;
        var t0 = performance.now();

        function loop() {
          if (performance.now() - t0 > CAL_DURATION) {
            var avg = sumRms / Math.max(n, 1);
            var cal = Math.max(avg, maxRms) * CAL_MARGIN;
            threshold = Math.round(Math.max(0.005, Math.min(0.15, cal)) * 1000) / 1000;
            el.slider.value = String(threshold);
            el.sliderDisp.textContent = fmtLvl(threshold);
            el.calStatus.textContent = 'Done \u2192 ' + fmtLvl(threshold);
            src.disconnect();
            c.close().catch(function(){});
            stream.getTracks().forEach(function(t) { t.stop(); });
            el.btnCalibrate.classList.remove('calibrating');
            return;
          }
          an.getFloatTimeDomainData(buf);
          var sum = 0;
          for (var i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
          var rms = Math.sqrt(sum / buf.length);
          if (rms > maxRms) maxRms = rms;
          sumRms += rms;
          n++;
          requestAnimationFrame(loop);
        }
        loop();
      });
    }).catch(function() {
      el.btnCalibrate.classList.remove('calibrating');
      el.calStatus.textContent = 'Mic access failed.';
    });
  });

  /* ---- audio ---- */
  function initAudio() {
    return navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: false }
    }).then(function(stream) {
      micStream  = stream;
      audioCtx   = new (window.AudioContext || window.webkitAudioContext)();
      var resumeP = (audioCtx.state === 'suspended') ? audioCtx.resume() : Promise.resolve();
      return resumeP.then(function() {
        sourceNode = audioCtx.createMediaStreamSource(stream);
        analyser   = audioCtx.createAnalyser();
        analyser.fftSize = FFT_SIZE;
        analyser.smoothingTimeConstant = 0.4;
        sourceNode.connect(analyser);
      });
    });
  }

  function teardownAudio() {
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
    if (sourceNode) { try { sourceNode.disconnect(); } catch(e){} sourceNode = null; }
    if (audioCtx) { audioCtx.close().catch(function(){}); audioCtx = null; }
    if (micStream) { micStream.getTracks().forEach(function(t) { t.stop(); }); micStream = null; }
    analyser = null;
  }

  /* ---- canvas ---- */
  function initCanvas() {
    canvas = el.vizCanvas;
    ctx    = canvas.getContext('2d');
    resizeCanvas();
  }

  function resizeCanvas() {
    if (!canvas) return;
    var box = canvas.parentElement;
    var sz  = Math.min(box.clientWidth, box.clientHeight);
    if (sz < 10) sz = 200; // fallback
    var dpr = window.devicePixelRatio || 1;
    canvas.width  = sz * dpr;
    canvas.height = sz * dpr;
    canvas.style.width  = sz + 'px';
    canvas.style.height = sz + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  /* ---- visualization ---- */
  function drawViz(rms, freqData, byteTimeDomain) {
    if (!ctx) return;
    var w  = canvas.clientWidth;
    var h  = canvas.clientHeight;
    var cx = w / 2;
    var cy = h / 2;
    var R  = Math.min(cx, cy) - 10;
    if (R < 10) return;

    ctx.clearRect(0, 0, w, h);

    // Threshold ring
    var thR = R * Math.min(threshold / 0.12, 1);
    ctx.beginPath();
    ctx.arc(cx, cy, thR, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(201,168,76,0.13)';
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 5]);
    ctx.stroke();
    ctx.setLineDash([]);

    // Frequency spectrum bars
    if (freqData) {
      var bins     = freqData.length;
      var useBins  = Math.floor(bins * 0.75);
      if (!smoothFreq || smoothFreq.length !== useBins) smoothFreq = new Float32Array(useBins);

      var baseR   = R * 0.38;
      var maxBarH = R * 0.52;
      var barW    = Math.max(1.5, (Math.PI * 2 * baseR) / useBins * 0.55);

      for (var i = 0; i < useBins; i++) {
        var raw = freqData[i] / 255;
        smoothFreq[i] += (raw - smoothFreq[i]) * 0.35;
        var val   = smoothFreq[i];
        var angle = (i / useBins) * Math.PI * 2 - Math.PI / 2;
        var barH  = val * maxBarH;
        var x1 = cx + Math.cos(angle) * baseR;
        var y1 = cy + Math.sin(angle) * baseR;
        var x2 = cx + Math.cos(angle) * (baseR + barH);
        var y2 = cy + Math.sin(angle) * (baseR + barH);

        var alpha = 0.25 + val * 0.65;
        var cr, cg, cb;
        if (rms >= threshold) {
          var t = Math.min((rms - threshold) / threshold, 1);
          cr = 240; cg = Math.round(84 + (1-t)*80); cb = Math.round(74 + (1-t)*50);
          alpha = 0.4 + val * 0.6;
        } else if (val > 0.4) {
          cr = 220; cg = 180; cb = 80;
        } else {
          cr = 180; cg = 165; cb = 110;
        }
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.strokeStyle = 'rgba('+cr+','+cg+','+cb+','+alpha+')';
        ctx.lineWidth = barW;
        ctx.lineCap = 'round';
        ctx.stroke();
      }
    }

    // Inner waveform ring
    if (byteTimeDomain && byteTimeDomain.length > 0) {
      var waveR   = R * 0.32;
      var waveAmp = R * 0.08;
      var len     = byteTimeDomain.length;
      ctx.beginPath();
      for (var j = 0; j <= len; j++) {
        var idx   = j % len;
        var ang   = (idx / len) * Math.PI * 2 - Math.PI / 2;
        var v     = byteTimeDomain[idx] / 128.0;
        var rr    = waveR + (v - 1.0) * waveAmp;
        var px    = cx + Math.cos(ang) * rr;
        var py    = cy + Math.sin(ang) * rr;
        if (j === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.strokeStyle = rms >= threshold ? 'rgba(240,84,74,0.35)' : 'rgba(201,168,76,0.18)';
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    // Central glow
    var glowR = R * Math.min(rms / 0.08, 1) * 0.7;
    if (glowR > 2) {
      var grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, glowR);
      if (rms >= threshold) {
        grad.addColorStop(0, 'rgba(240,84,74,0.18)');
        grad.addColorStop(1, 'rgba(240,84,74,0)');
      } else {
        grad.addColorStop(0, 'rgba(201,168,76,0.09)');
        grad.addColorStop(1, 'rgba(201,168,76,0)');
      }
      ctx.beginPath();
      ctx.arc(cx, cy, glowR, 0, Math.PI * 2);
      ctx.fillStyle = grad;
      ctx.fill();
    }

    // Center dot
    ctx.beginPath();
    ctx.arc(cx, cy, 2.5, 0, Math.PI * 2);
    ctx.fillStyle = rms >= threshold ? 'rgba(240,84,74,0.7)' : 'rgba(201,168,76,0.35)';
    ctx.fill();
  }

  /* ---- main loop ---- */
  function tick(now) {
    if (gameState !== 'running' && gameState !== 'paused') return;

    if (gameState === 'running') {
      var elapsed = elapsedBeforePause + (now - startedAt);
      remainingMs = Math.max(0, durationMs - elapsed);
      el.timerText.textContent = fmtTime(remainingMs);

      // Progress border
      var fraction = 1 - (remainingMs / durationMs);
      updateProgressBorder(fraction);
      if (remainingMs / durationMs < 0.15) el.progressBorder.classList.add('danger');
      else el.progressBorder.classList.remove('danger');

      // Audio
      if (analyser) {
        var freqData  = new Uint8Array(analyser.frequencyBinCount);
        var timeData  = new Uint8Array(analyser.fftSize);
        var floatData = new Float32Array(analyser.fftSize);
        analyser.getByteFrequencyData(freqData);
        analyser.getByteTimeDomainData(timeData);
        analyser.getFloatTimeDomainData(floatData);

        var sum = 0;
        for (var i = 0; i < floatData.length; i++) sum += floatData[i] * floatData[i];
        currentLevel = Math.sqrt(sum / floatData.length);
        if (currentLevel > peakLevel) peakLevel = currentLevel;

        el.vizLevel.textContent = fmtLvl(currentLevel);
        el.statPeak.textContent = fmtLvl(peakLevel);

        if (currentLevel >= threshold)            el.vizLevel.style.color = '#f0544a';
        else if (currentLevel >= threshold * 0.7) el.vizLevel.style.color = '#e8a840';
        else                                      el.vizLevel.style.color = '';

        // Debounced threshold check
        if (currentLevel >= threshold) {
          if (aboveThresholdAt === null) aboveThresholdAt = now;
          else if (now - aboveThresholdAt >= DEBOUNCE_MS) { endGame('lose'); return; }
        } else {
          aboveThresholdAt = null;
        }

        drawViz(currentLevel, freqData, timeData);
      }

      if (remainingMs <= 0) { endGame('win'); return; }
    } else {
      drawViz(currentLevel, null, null);
    }

    rafId = requestAnimationFrame(tick);
  }

  /* ---- game control ---- */
  function startGame() {
    peakLevel          = 0;
    currentLevel       = 0;
    aboveThresholdAt   = null;
    durationMs         = selectedDuration * 1000;
    elapsedBeforePause = 0;
    remainingMs        = durationMs;
    smoothFreq         = null;
    el.statThreshold.textContent = fmtLvl(threshold);
    el.timerText.textContent     = fmtTime(durationMs);

    initAudio().then(function() {
      gameState = 'running';
      startedAt = performance.now();

      initCanvas();
      sizeProgressRect();
      el.progressBorder.classList.add('visible');
      el.progressBorder.classList.remove('danger');

      showScreen('running');
      el.btnPause.textContent = 'Pause';
      screens.running.classList.remove('paused-state');

      acquireWakeLock();
      rafId = requestAnimationFrame(tick);

    }).catch(function(err) {
      var msg = 'This game needs microphone access to detect sound.';
      if (err && err.name === 'NotAllowedError')   msg = 'Microphone permission was denied. Please allow access and try again.';
      else if (err && err.name === 'NotFoundError') msg = 'No microphone found. Please connect one and try again.';
      else if (err && err.name === 'NotReadableError') msg = 'Microphone is in use by another app.';
      el.micErrorMsg.textContent = msg;
      el.micError.hidden = false;
    });
  }

  function endGame(result) {
    gameState = result;
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
    teardownAudio();
    releaseWakeLock();
    el.progressBorder.classList.remove('visible');
    el.progressBorder.classList.remove('danger');

    if (result === 'win') {
      el.winDuration.textContent  = fmtTimeSec(selectedDuration);
      el.winMaxLevel.textContent  = fmtLvl(peakLevel);
      el.winThreshold.textContent = fmtLvl(threshold);
      showScreen('win');
    } else {
      el.loseTimeLeft.textContent  = fmtTime(remainingMs);
      el.losePeak.textContent      = fmtLvl(peakLevel);
      el.loseThreshold.textContent = fmtLvl(threshold);
      showScreen('lose');
    }
  }

  function stopGame() {
    gameState = 'idle';
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
    teardownAudio();
    releaseWakeLock();
    el.progressBorder.classList.remove('visible');
    el.progressBorder.classList.remove('danger');
    showScreen('idle');
  }

  function togglePause() {
    if (gameState === 'running') {
      elapsedBeforePause += performance.now() - startedAt;
      gameState = 'paused';
      el.btnPause.textContent = 'Resume';
      screens.running.classList.add('paused-state');
      if (audioCtx && audioCtx.state === 'running') audioCtx.suspend();
    } else if (gameState === 'paused') {
      gameState = 'running';
      startedAt = performance.now();
      aboveThresholdAt = null;
      el.btnPause.textContent = 'Pause';
      screens.running.classList.remove('paused-state');
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    }
  }

  /* ---- info modal ---- */
  function openInfo()  { el.infoModal.hidden = false; }
  function closeInfo() { el.infoModal.hidden = true; }
  el.btnInfo.addEventListener('click', openInfo);
  el.btnCloseInfo.addEventListener('click', closeInfo);
  el.btnCloseInfo2.addEventListener('click', closeInfo);
  el.infoModal.addEventListener('click', function(e) { if (e.target === el.infoModal) closeInfo(); });

  /* ---- event bindings ---- */
  el.btnStart.addEventListener('click', startGame);
  el.btnPause.addEventListener('click', togglePause);
  el.btnStop.addEventListener('click', stopGame);
  el.btnAgainWin.addEventListener('click', function() { gameState = 'idle'; showScreen('idle'); });
  el.btnAgainLose.addEventListener('click', function() { gameState = 'idle'; showScreen('idle'); });
  el.btnDismissErr.addEventListener('click', function() { el.micError.hidden = true; });

  /* ---- resize ---- */
  var resizeT;
  window.addEventListener('resize', function() {
    clearTimeout(resizeT);
    resizeT = setTimeout(function() {
      if (gameState === 'running' || gameState === 'paused') {
        resizeCanvas();
        sizeProgressRect();
      }
    }, 120);
  });

  /* ---- init ---- */
  showScreen('idle');
})();
</script>
</body>
</html>
